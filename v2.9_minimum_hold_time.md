# v2.9: Minimum Position Hold Time

## Problem Identified

After implementing v2.8 with separate graph updates (0.5s) and trading decisions (5s), we observed a critical issue:

**Positions were exiting every 5 seconds**, which prevented the scaling strategy from working properly:

- Positions closed immediately after opening
- Scale in/out operations couldn't execute multiple times
- Strategy didn't have time to develop positions
- Exits were time-driven (every 5s) not logic-driven (TP/SL/reversal)

### User Feedback
*"det känns som att låta den läsa av var 5 sekund inte var lösningen då blir det en exit var 5 sekund nu, jag vill att vi låter varje position få verka och scala in och ut ordentligt så vår strategi får jobba, inte bara gå ut och in, viktigt att strategin ger mening åt exit inte bara tiden"*

**Translation:** "letting it check every 5 seconds wasn't the solution since exits happen every 5 seconds now, I want to let each position work and scale in and out properly so our strategy gets to work, not just go in and out, important that the strategy gives meaning to exits not just the time"

## Root Cause

The issue was that `maybe_exit()` was being called every 5 seconds (POLL_SEC), and would check exit conditions immediately. Without a minimum hold time, positions would exit as soon as any exit condition was met, which could happen within seconds of entry.

This defeated the purpose of the **progressive scaling strategy**, which needs time to:
1. Let price move relative to entry
2. Scale in when price is favorable
3. Scale out when price is adverse
4. Build a position over time

## Solution: Minimum Hold Time

Added `MIN_HOLD_TIME_SEC` parameter (default: 60 seconds):

### Changes Made

**1. config.json - New Parameter:**
```json
{
  "min_hold_time_sec": 60,
  "_comment_min_hold_time": "CRITICAL: Minimum 60s hold time per position - lets scaling strategy work properly. Prevents exits before scale in/out can execute. Exits must be strategy-driven (TP/SL/reversal) not time-driven. Max loss protection still overrides this."
}
```

**2. Main Script - Load Parameter:**
```python
# Minimum hold time - låt positionen utvecklas innan exit
MIN_HOLD_TIME_SEC = float(cfg.get("min_hold_time_sec", 60))  # Minst 1 minut i position innan exit tillåts
```

**3. maybe_exit() - Hold Time Check:**
```python
def maybe_exit(price: Decimal):
    """
    ADAPTIVE EXIT: Använder current_mode för att avgöra exit-logik
    - BREAKOUT mode: TP vid fortsatt rörelse bort från L, Stop vid återgång till L
    - MEAN_REVERSION mode: TP vid återgång till L, Stop vid fortsatt rörelse från L
    """
    global L
    
    # MINIMUM HOLD TIME: Låt positionen utvecklas och scala innan exit
    # (Max loss protection körs INNAN maybe_exit i main loop, så den kan fortfarande exit direkt)
    if pos.side != "FLAT" and pos.entry_time > 0:
        time_in_position = time.time() - pos.entry_time
        if time_in_position < MIN_HOLD_TIME_SEC:
            # Håll kvar positionen tills minimum hold time uppnåtts
            # Detta ger scaling-strategin tid att jobba
            return
    
    # ... rest of exit logic ...
```

**4. Startup Log:**
```python
print(f"⏱️ Min hold: {MIN_HOLD_TIME_SEC:.0f}s (låter scaling jobba) | Cooldown: {COOLDOWN_SEC:.1f}s | TP-chain: {TP_CHAIN_MAX}")
```

### How It Works

1. **Position Entry:** When entering LONG or SHORT, `entry_time` is recorded
2. **Hold Time Check:** Before allowing any exit, check `time.time() - pos.entry_time`
3. **Minimum Period:** If less than 60 seconds, return early (skip exit logic)
4. **Scaling Allowed:** Scale in/out operations still work during hold period
5. **Safety Override:** Max loss protection runs BEFORE maybe_exit in main loop, so it can still force immediate exit

### Exit Flow with Hold Time

```
Main Loop (every 5s trading decision):
├─ check_scale_out(price)           ← Runs during hold time ✓
├─ check_scale_in(price)            ← Runs during hold time ✓
├─ check_max_loss_protection(price) ← OVERRIDES hold time ✓
└─ maybe_exit(price)                ← Blocked if < 60s ✗
   ├─ Hold time check
   │  └─ If < 60s: return early
   └─ Normal exit logic (TP, L-cross, etc.)
```

## Expected Benefits

### Before v2.9 (Problem):
- ❌ Exits every ~5 seconds
- ❌ Positions close before scaling can work
- ❌ Time-driven exits (every poll)
- ❌ Strategy doesn't get to develop positions
- ❌ Many small trades with little meaning

### After v2.9 (Solution):
- ✅ Positions hold minimum 60 seconds
- ✅ Scaling strategy has time to execute
- ✅ Logic-driven exits (TP hit, SL hit, trend reversal)
- ✅ Strategy gets time to work properly
- ✅ Fewer but higher-quality trades
- ✅ Multiple scale in/out per position

## Configuration Options

### Tuning MIN_HOLD_TIME_SEC

**Default: 60 seconds** - Good starting point for most strategies

**Consider adjusting based on:**

- **Volatility:** Lower hold time (30-45s) in high volatility, higher (90-120s) in low volatility
- **Timeframe:** Shorter for scalping strategies, longer for swing trading
- **Scaling frequency:** Needs to be long enough for multiple scaling operations
- **Trading style:** Aggressive = shorter, Conservative = longer

### Example Settings:

```json
// Scalping (fast trades)
"min_hold_time_sec": 30

// Default (balanced)
"min_hold_time_sec": 60

// Swing (longer positions)
"min_hold_time_sec": 120

// Day trading (development time)
"min_hold_time_sec": 90
```

## Important Notes

### What Hold Time DOES:
- ✅ Prevents premature exits before scaling can work
- ✅ Ensures positions develop properly
- ✅ Forces strategy-driven exits (TP/SL/logic)
- ✅ Allows scaling operations to execute multiple times

### What Hold Time DOES NOT Do:
- ❌ Does NOT prevent max loss protection (overridden)
- ❌ Does NOT prevent max time exit (checked after hold time)
- ❌ Does NOT block scaling in/out
- ❌ Does NOT guarantee holding exactly 60s (can hold longer)

### Safety Mechanisms Still Work:
1. **Max Loss Protection:** Runs before maybe_exit, can exit immediately
2. **Max Hold Time:** Still enforced after minimum hold period
3. **Mode Switch Exits:** Can force exit if configured

## Testing Recommendations

1. **Monitor trade duration:** Check if most trades hold > 60s
2. **Count scaling operations:** Should see multiple scale in/out per position
3. **Exit reasons:** Most exits should be TP/SL/L-cross, not just time
4. **Trade quality:** Better average profit per trade
5. **Position development:** Positions should scale in multiple times before exiting

## Version History

- **v2.7:** Set poll_sec to 5.0 (reduced over-trading)
- **v2.8:** Separate graph (0.5s) and trading (5s) updates
- **v2.9:** Add minimum position hold time (60s) - **CURRENT**

## Next Steps

Consider implementing:

1. **Variable hold time based on volatility:** Hold longer in low volatility
2. **Different hold times for LONG vs SHORT:** May need different durations
3. **Profitable exit override:** Allow early exit if profit > X%
4. **Hold time logging:** Track when hold time prevents exits
5. **Scaling metrics:** Monitor scaling operations per position

---

**Result:** Strategy now gives positions time to develop and scale properly, with exits driven by strategy logic (TP/SL/reversal) rather than polling frequency.
